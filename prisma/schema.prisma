generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// USER
model User {
  id            String    @id @default(cuid())
  clerkId       String    @unique
  email         String    @unique
  name          String?
  image         String?

  subscriptionStatus SubscriptionStatus @default(FREE)

  // Préférences d'investissement BA (Business Angel)
  // Stocké en JSON pour flexibilité (voir BAPreferences dans services/benchmarks/types.ts)
  investmentPreferences Json?

  deals         Deal[]

  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
}

enum SubscriptionStatus {
  FREE
  PRO
  ENTERPRISE
}

// DEAL
model Deal {
  id              String   @id @default(cuid())
  userId          String
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  name            String
  companyName     String?
  website         String?
  description     String?  @db.Text

  sector          String?
  stage           DealStage?
  geography       String?

  arr             Decimal? @db.Decimal(12, 2)
  growthRate      Decimal? @db.Decimal(5, 2)
  amountRequested Decimal? @db.Decimal(12, 2)
  valuationPre    Decimal? @db.Decimal(14, 2)

  status          DealStatus @default(SCREENING)

  // Scores (after analysis)
  globalScore     Int?
  teamScore       Int?
  marketScore     Int?
  productScore    Int?
  financialsScore Int?

  documents       Document[]
  founders        Founder[]
  redFlags        RedFlag[]
  analyses        Analysis[]

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([userId])
  @@index([status])
}

enum DealStage {
  PRE_SEED
  SEED
  SERIES_A
  SERIES_B
  SERIES_C
  LATER
}

enum DealStatus {
  SCREENING
  ANALYZING
  IN_DD
  PASSED
  INVESTED
  ARCHIVED
}

// FOUNDER
model Founder {
  id              String   @id @default(cuid())
  dealId          String
  deal            Deal     @relation(fields: [dealId], references: [id], onDelete: Cascade)

  name            String
  role            String
  linkedinUrl     String?

  previousVentures Json?
  verifiedInfo    Json?

  createdAt       DateTime @default(now())

  @@index([dealId])
}

// DOCUMENT
model Document {
  id               String   @id @default(cuid())
  dealId           String
  deal             Deal     @relation(fields: [dealId], references: [id], onDelete: Cascade)

  name             String
  type             DocumentType
  customType       String?   // For OTHER type - user-specified description
  comments         String?   @db.Text  // Additional context/notes
  storagePath      String
  storageUrl       String?
  mimeType         String?
  sizeBytes        Int?

  processingStatus ProcessingStatus @default(PENDING)
  extractedText    String?  @db.Text

  // Extraction quality tracking
  extractionQuality   Int?      // 0-100 quality score
  extractionMetrics   Json?     // Full quality metrics
  extractionWarnings  Json?     // Array of warnings
  requiresOCR         Boolean   @default(false)
  ocrProcessed        Boolean   @default(false)
  ocrText             String?   @db.Text  // Text from OCR if processed

  uploadedAt       DateTime @default(now())

  @@index([dealId])
}

enum DocumentType {
  PITCH_DECK
  FINANCIAL_MODEL
  CAP_TABLE
  TERM_SHEET
  INVESTOR_MEMO
  FINANCIAL_STATEMENTS
  LEGAL_DOCS
  MARKET_STUDY
  PRODUCT_DEMO
  OTHER
}

enum ProcessingStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
}

// RED FLAG
model RedFlag {
  id              String   @id @default(cuid())
  dealId          String
  deal            Deal     @relation(fields: [dealId], references: [id], onDelete: Cascade)

  category        RedFlagCategory
  title           String
  description     String   @db.Text
  severity        RedFlagSeverity
  confidenceScore Decimal  @db.Decimal(3, 2)

  evidence        Json
  questionsToAsk  String[]

  status          RedFlagStatus @default(OPEN)

  detectedAt      DateTime @default(now())

  @@index([dealId])
  @@index([severity])
}

enum RedFlagCategory {
  FOUNDER
  FINANCIAL
  MARKET
  PRODUCT
  DEAL_STRUCTURE
}

enum RedFlagSeverity {
  CRITICAL
  HIGH
  MEDIUM
  LOW
}

enum RedFlagStatus {
  OPEN
  INVESTIGATING
  RESOLVED
  ACCEPTED
}

// ANALYSIS
model Analysis {
  id              String   @id @default(cuid())
  dealId          String
  deal            Deal     @relation(fields: [dealId], references: [id], onDelete: Cascade)

  type            AnalysisType
  mode            String?  // tier1_complete, tier2_synthesis, full_analysis, etc.
  status          AnalysisStatus @default(PENDING)

  totalAgents     Int
  completedAgents Int      @default(0)

  summary         String?  @db.Text
  results         Json?    // Full agent results stored as JSON

  startedAt       DateTime?
  completedAt     DateTime?

  totalCost       Decimal? @db.Decimal(6, 4)
  totalTimeMs     Int?

  // Cache invalidation: fingerprint of deal state at analysis time
  // If deal changes, fingerprint changes, cache is invalid
  dealFingerprint String?
  useReAct        Boolean  @default(false)

  // Document versioning: track which documents were analyzed
  // Allows detecting "stale" analyses when new docs are added
  documentIds     String[] @default([])

  createdAt       DateTime @default(now())

  @@index([dealId])
  @@index([dealId, mode, dealFingerprint]) // For cache lookup
}

enum AnalysisType {
  SCREENING
  FULL_DD
}

enum AnalysisStatus {
  PENDING
  RUNNING
  COMPLETED
  FAILED
}

// BENCHMARK (pre-seeded) - Generic metrics
model Benchmark {
  id              String   @id @default(cuid())

  sector          String
  stage           String
  metricName      String

  p25             Decimal  @db.Decimal(10, 2)
  median          Decimal  @db.Decimal(10, 2)
  p75             Decimal  @db.Decimal(10, 2)

  source          String

  createdAt       DateTime @default(now())

  @@unique([sector, stage, metricName])
  @@index([sector, stage])
}

// SECTOR BENCHMARK - Rich sector-specific benchmarks (Tier 3 experts)
// Stored as JSON for flexibility - can be updated without schema changes
model SectorBenchmark {
  id              String   @id @default(cuid())

  sector          String   @unique // e.g., "SaaS B2B", "FinTech", "Marketplace"

  // Full benchmark data as JSON (primaryMetrics, secondaryMetrics, exitMultiples, etc.)
  data            Json

  // Versioning for cache invalidation and audit
  version         Int      @default(1)
  source          String?  // e.g., "OpenVC 2024", "First Round State of Startups"

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([sector])
}

// ============================================================================
// PRODUCTION ARCHITECTURE MODELS
// ============================================================================

// SCORED FINDING - Individual metric with benchmark comparison
model ScoredFinding {
  id              String   @id @default(cuid())
  analysisId      String
  agentName       String

  metric          String
  category        String   // financial, team, market, product, etc.
  value           String?  // Stored as string for flexibility
  unit            String
  normalizedValue Float?   // 0-100 normalized score

  percentile      Int?     // 0-100 percentile vs benchmark
  assessment      String   // below_average, average, above_average, etc.

  // Benchmark comparison
  benchmarkData   Json?    // { sector, stage, p25, median, p75, source }

  // Confidence breakdown
  confidenceLevel String   // high, medium, low, insufficient
  confidenceScore Int      // 0-100
  confidenceFactors Json?  // Array of { name, weight, score, reason }

  // Evidence chain
  evidence        Json?    // Array of { type, content, source, confidence }

  // Link to reasoning trace
  reasoningTraceId String?

  createdAt       DateTime @default(now())

  @@index([analysisId])
  @@index([agentName])
  @@index([metric])
}

// REASONING TRACE - Full ReAct trace for an agent run
model ReasoningTrace {
  id              String   @id @default(cuid())
  analysisId      String
  agentName       String

  taskDescription String   @db.Text

  // ReAct steps as JSON array
  // Each step: { stepNumber, thought, action?, observation?, confidenceAfterStep }
  steps           Json

  totalIterations Int
  finalConfidence Float
  executionTimeMs Int

  // Self-critique results if any
  selfCritique    Json?    // { critiques, overallAssessment, suggestedImprovements }

  createdAt       DateTime @default(now())

  @@index([analysisId])
  @@index([agentName])
}

// DEBATE RECORD - Structured debate between agents
model DebateRecord {
  id              String   @id @default(cuid())
  analysisId      String

  contradictionId String   @unique
  topic           String
  severity        String   // minor, moderate, major, critical

  // Participating agents
  participants    String[] // Array of agent names

  // Claims being debated
  claims          Json     // Array of { agentName, findingId, claim, value, confidence }

  // Debate rounds
  // Each round: { roundNumber, positions: [{ agentName, position, evidence, counterArgs }] }
  rounds          Json

  // Resolution
  resolvedBy      String?  // consensus, arbitration, accepted
  winner          String?  // Winning agent name
  resolution      String?  @db.Text
  finalValue      String?

  // Resolution confidence
  resolutionConfidence Int?

  status          String   @default("detected") // detected, debating, resolved, accepted

  createdAt       DateTime @default(now())
  resolvedAt      DateTime?

  @@index([analysisId])
  @@index([status])
}

// AGENT MESSAGE - Inter-agent communication log
model AgentMessage {
  id              String   @id @default(cuid())
  analysisId      String

  messageType     String   // finding, question, contradiction, request, response, etc.
  topic           String   // financial, team, market, etc.
  priority        String   // low, normal, high, critical

  fromAgent       String
  toAgent         String   // Can be "*" for broadcast

  subject         String
  payload         Json

  correlationId   String?  // For request/response pairs
  replyTo         String?  // Message ID this is replying to

  acknowledged    Boolean  @default(false)
  processedBy     String[] // Array of agent names that processed this

  createdAt       DateTime @default(now())
  expiresAt       DateTime?

  @@index([analysisId])
  @@index([fromAgent])
  @@index([toAgent])
  @@index([messageType])
}

// STATE TRANSITION - Analysis state machine history
model StateTransition {
  id              String   @id @default(cuid())
  analysisId      String

  fromState       String
  toState         String
  trigger         String

  metadata        Json?

  createdAt       DateTime @default(now())

  @@index([analysisId])
}

// ANALYSIS CHECKPOINT - Recovery points
model AnalysisCheckpoint {
  id              String   @id @default(cuid())
  analysisId      String

  state           String

  completedAgents String[]
  pendingAgents   String[]
  failedAgents    Json?    // Array of { agent, error, retries }

  findings        Json?    // Snapshot of findings at this point
  results         Json?    // Snapshot of results

  createdAt       DateTime @default(now())

  @@index([analysisId])
}

// ============================================================================
// AI BOARD - Multi-LLM Deliberation Feature
// ============================================================================

// AI BOARD SESSION - A deliberation session on a deal
model AIBoardSession {
  id              String   @id @default(cuid())
  dealId          String
  userId          String

  status          BoardStatus @default(INITIALIZING)

  // Verdict outcome
  verdict         BoardVerdict?
  consensusLevel  ConsensusLevel?
  stoppingReason  String?  // consensus, majority_stable, max_rounds, stagnation

  // Summary outputs
  consensusPoints Json?    // Array of agreed points
  frictionPoints  Json?    // Array of disagreed points
  questionsForFounder Json? // Array of follow-up questions

  // Execution details
  totalRounds     Int      @default(0)
  totalCost       Decimal? @db.Decimal(8, 4)
  totalTimeMs     Int?

  members         AIBoardMember[]
  rounds          AIBoardRound[]

  startedAt       DateTime?
  completedAt     DateTime?
  createdAt       DateTime @default(now())

  @@index([dealId])
  @@index([userId])
  @@index([status])
}

enum BoardStatus {
  INITIALIZING
  ANALYZING
  DEBATING
  VOTING
  COMPLETED
  FAILED
  STOPPED
}

enum BoardVerdict {
  GO
  NO_GO
  NEED_MORE_INFO
}

enum ConsensusLevel {
  UNANIMOUS      // 4/4
  STRONG         // 3/4
  SPLIT          // 2/2
  MINORITY       // 1/3
}

// AI BOARD MEMBER - A participating LLM in the board
model AIBoardMember {
  id              String   @id @default(cuid())
  sessionId       String
  session         AIBoardSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  modelId         String   // e.g., "CLAUDE_OPUS_45", "GPT4_TURBO"
  modelName       String   // Human-readable name
  color           String   // Color for UI display

  // Initial analysis
  initialAnalysis Json?    // { verdict, arguments, concerns, confidence }

  // Final vote
  finalVote       BoardVerdict?
  finalConfidence Int?     // 0-100
  voteJustification String? @db.Text

  // Execution details
  analysisCost    Decimal? @db.Decimal(6, 4)
  debateCost      Decimal? @db.Decimal(6, 4)
  voteCost        Decimal? @db.Decimal(6, 4)
  totalCost       Decimal? @db.Decimal(6, 4)

  // Error tracking
  failedAt        String?  // Phase where it failed
  errorMessage    String?

  createdAt       DateTime @default(now())

  @@index([sessionId])
}

// AI BOARD ROUND - A debate round
model AIBoardRound {
  id              String   @id @default(cuid())
  sessionId       String
  session         AIBoardSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  roundNumber     Int
  roundType       RoundType

  // Responses from each member
  // Array of { memberId, modelId, response, positionChanged, respondingTo, timestamp }
  responses       Json

  // Consensus check after this round
  currentVerdicts Json?    // { memberId: verdict }
  consensusReached Boolean @default(false)
  majorityStable  Boolean  @default(false)

  totalCost       Decimal? @db.Decimal(6, 4)
  durationMs      Int?

  createdAt       DateTime @default(now())

  @@index([sessionId])
  @@unique([sessionId, roundNumber])
}

enum RoundType {
  INITIAL_ANALYSIS
  DEBATE
  FINAL_VOTE
}

// USER BOARD CREDITS - Credits for AI Board usage
model UserBoardCredits {
  id              String   @id @default(cuid())
  userId          String   @unique

  // Monthly allocation based on subscription
  monthlyAllocation Int    @default(0)  // 0 for FREE, 5 for PRO
  usedThisMonth   Int      @default(0)

  // Extra purchased credits (never expire)
  extraCredits    Int      @default(0)

  // Reset tracking
  lastResetAt     DateTime @default(now())

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([userId])
}

// USER DEAL USAGE - Track monthly deal analysis usage
model UserDealUsage {
  id              String   @id @default(cuid())
  userId          String   @unique

  // Monthly limits based on subscription
  // FREE = 5 deals/month (Tier 1 only)
  // PRO = unlimited
  monthlyLimit    Int      @default(5)
  usedThisMonth   Int      @default(0)

  // Track highest tier used this month (for analytics)
  tier1Count      Int      @default(0)
  tier2Count      Int      @default(0)
  tier3Count      Int      @default(0)

  // Reset tracking
  lastResetAt     DateTime @default(now())

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([userId])
}

// ============================================================================
// COMPANY DATABASE - Central registry of startups/companies
// ============================================================================

// COMPANY - Master record for each startup
model Company {
  id              String   @id @default(cuid())

  // Identity
  name            String   // Official company name
  slug            String   @unique // Normalized for deduplication (lowercase, no special chars)
  aliases         String[] // Alternative names, previous names

  // Description
  description     String?  @db.Text
  shortDescription String? // One-liner
  website         String?
  linkedinUrl     String?
  crunchbaseUrl   String?

  // Classification
  industry        String?  // Primary industry from taxonomy
  subIndustry     String?  // More specific classification
  businessModel   String?  // SaaS, Marketplace, Transactional, Hardware, Services
  targetMarket    String?  // B2B, B2C, B2B2C
  useCases        String[] // Problems solved (for competitor matching)

  // Location
  headquarters    String?  // Country
  city            String?
  region          String?  // europe, north_america, asia, etc.

  // Company details
  foundedYear     Int?
  founders        Json?    // Array of {name, role, background, linkedinUrl}
  employeeCount   Int?
  employeeRange   String?  // "1-10", "11-50", "51-200", etc.

  // Status
  status          CompanyStatus @default(ACTIVE)
  statusDetails   String?  // e.g., "Acquis par Google en 2024", "Liquidation judiciaire"
  statusUpdatedAt DateTime? // Last time status was verified
  acquiredBy      String?  // If acquired, by whom
  acquiredDate    DateTime?
  shutdownDate    DateTime?

  // Financials (latest known)
  totalRaised     Decimal? @db.Decimal(14, 2)
  lastValuation   Decimal? @db.Decimal(14, 2)
  lastRoundStage  String?
  lastRoundDate   DateTime?

  // Metrics (latest known)
  arr             Decimal? @db.Decimal(14, 2)
  mrr             Decimal? @db.Decimal(14, 2)
  revenue         Decimal? @db.Decimal(14, 2)
  growthRate      Int?     // YoY growth %
  customers       Int?
  nrr             Int?     // Net Revenue Retention %
  isProfitable    Boolean?
  isEbitdaPositive Boolean?

  // Competitive landscape
  competitors     String[] // Slugs of competitor companies
  notableClients  String[]

  // Relations
  fundingRounds   FundingRound[]
  enrichments     CompanyEnrichment[]

  // Metadata
  dataQuality     Int?     @default(0) // 0-100 score
  lastEnrichedAt  DateTime?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Enrichment locking (prevent concurrent processing)
  enrichmentLockedAt DateTime? // When the lock was acquired
  enrichmentLockedBy String?   // Run ID that holds the lock

  @@index([name])
  @@index([industry])
  @@index([headquarters])
  @@index([status])
  @@index([totalRaised])
  @@index([lastRoundDate])
  @@index([enrichmentLockedAt])
}

enum CompanyStatus {
  ACTIVE
  ACQUIRED
  SHUTDOWN
  INACTIVE
  UNKNOWN
}

// COMPANY ENRICHMENT - History of data additions/updates
model CompanyEnrichment {
  id              String   @id @default(cuid())
  companyId       String
  company         Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)

  // What was added/updated
  source          EnrichmentSource
  sourceUrl       String?  // Article URL, search result, etc.
  sourceDate      DateTime? // Date of the source

  // Data changes
  fieldsUpdated   String[] // List of fields that were updated
  previousData    Json?    // Previous values (for audit)
  newData         Json     // New values added

  // Quality
  confidence      Int?     // 0-100
  verifiedBy      String?  // If manually verified

  createdAt       DateTime @default(now())

  @@index([companyId])
  @@index([source])
  @@index([createdAt])
}

enum EnrichmentSource {
  ARTICLE_IMPORT    // From FrenchWeb, Maddyness, etc.
  WEB_SEARCH        // From searching for competitors/info
  PITCH_DECK        // From analyzing a deal's pitch deck
  MANUAL            // Manual data entry
  API               // From external API (Crunchbase, etc.)
  LLM_EXTRACTION    // From LLM analysis
}

// ============================================================================
// FUNDING ROUNDS DATABASE - Historical deals for comparisons
// ============================================================================

// FUNDING ROUND - Individual funding event
model FundingRound {
  id              String   @id @default(cuid())

  // Link to Company (optional for migration, will become required)
  companyId       String?
  company         Company? @relation(fields: [companyId], references: [id], onDelete: SetNull)

  // Company info (legacy - will be deprecated after migration)
  companyName     String
  companySlug     String?  // Normalized name for deduplication
  description     String?  @db.Text
  tagline         String?  // One-liner (e.g., "Slack for healthcare")
  website         String?
  linkedinUrl     String?  // LinkedIn company page

  // ============================================================================
  // USE CASES & BUSINESS MODEL (for competitor detection)
  // ============================================================================
  useCases        String[] // Problems solved (e.g., ["invoice management", "expense tracking"])
  businessModel   String?  // SaaS, Marketplace, Transactional, Hardware, Services
  targetMarket    String?  // B2B, B2C, B2B2C

  // Funding details
  amount          Decimal? @db.Decimal(14, 2) // In original currency
  amountUsd       Decimal? @db.Decimal(14, 2) // Converted to USD for comparison
  currency        String   @default("USD")

  // Round info
  stage           String?  // seed, series_a, series_b, etc.
  stageNormalized String?  // Normalized stage for filtering

  // Location (legacy - prefer Company.headquarters)
  geography       String?  // Country
  city            String?
  region          String?  // e.g., "Europe", "North America"

  // Sector (legacy - prefer Company.industry)
  sector          String?
  sectorNormalized String? // Normalized sector for filtering
  subSector       String?

  // Investors for THIS round
  investors       String[] // Array of investor names
  investorsFunds  String[] // VC/PE funds
  investorsAngels String[] // Business angels (individuals)
  investorsCorporates String[] // Corporate investors
  leadInvestor    String?

  // ============================================================================
  // VALUATION & METRICS AT RAISE (for benchmark comparison)
  // ============================================================================
  valuationPre    Decimal? @db.Decimal(14, 2)
  valuationPost   Decimal? @db.Decimal(14, 2)
  valuationMultiple Float? // Multiple ARR (e.g., 25x) - calculated or reported
  isDownRound     Boolean? // True if valuation < previous round

  // Metrics at the time of raise (for accurate benchmarking)
  arrAtRaise      Decimal? @db.Decimal(14, 2) // ARR at time of funding
  mrrAtRaise      Decimal? @db.Decimal(14, 2) // MRR at time of funding
  growthRateAtRaise Float? // YoY growth % at time of funding
  employeesAtRaise Int?    // Headcount at time of funding

  // Dates
  fundingDate     DateTime?
  announcedDate   DateTime?

  // Source tracking
  source          String   // "kaggle_crunchbase", "frenchweb", "techcrunch", etc.
  sourceUrl       String?
  sourceId        String?  // Original ID from source (for deduplication)

  // Metadata (legacy - prefer Company fields)
  employeeCount   Int?
  foundedYear     Int?

  // Use of funds for this round
  useOfFunds      String?  @db.Text
  hiringPlans     String?
  expansionPlans  String?

  // Enriched data (from LLM extraction)
  enrichedData    Json?    // Full extracted data
  confidenceScore Int?     // 0-100 extraction confidence
  isEnriched      Boolean  @default(false)
  isMigrated      Boolean  @default(false) // True when linked to Company

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@unique([source, sourceId]) // Prevent duplicate imports
  // Note: Duplicate round prevention handled in application logic
  // Can't use DB constraint due to nullable fields
  @@index([companyId])
  @@index([companyName])
  @@index([companySlug])
  @@index([stageNormalized])
  @@index([sectorNormalized])
  @@index([geography])
  @@index([region])
  @@index([fundingDate])
  @@index([amountUsd])
  @@index([isMigrated])
  @@index([businessModel])
  @@index([targetMarket])
  @@index([isDownRound])
}

// FUNDING SOURCE - Track data sources and their freshness
model FundingSource {
  id              String   @id @default(cuid())

  name            String   @unique // "kaggle_crunchbase", "frenchweb", etc.
  displayName     String
  description     String?
  sourceType      String   @default("rss") // "rss", "api", "scrape", "archive"
  sourceUrl       String?  // Base URL for the source

  // Stats
  totalRounds     Int      @default(0)
  lastImportAt    DateTime?
  lastImportCount Int?

  // Pagination state for historical imports
  cursor          String?  // Current position (page number, date, offset, etc.)
  cursorType      String?  // "page", "date", "offset", "token"
  historicalImportComplete Boolean @default(false)
  oldestDateImported DateTime? // Track how far back we've gone

  // Config
  isActive        Boolean  @default(true)
  autoRefresh     Boolean  @default(false)
  refreshIntervalHours Int?

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
}

// ============================================================================
// COST MONITORING - Granular cost tracking for admin dashboard
// ============================================================================

// COST EVENT - Individual API call for detailed tracking
model CostEvent {
  id              String   @id @default(cuid())

  // Linking
  userId          String   // Owner of the deal
  dealId          String
  analysisId      String?  // Optional: linked analysis
  boardSessionId  String?  // Optional: linked board session

  // Call details
  model           String   // e.g., "claude-3-5-sonnet", "gpt-4o"
  agent           String   // e.g., "deal-screener", "market-expert", "board-opus"
  operation       String   // e.g., "screening", "extraction", "board-analysis", "board-debate"

  // Tokens
  inputTokens     Int
  outputTokens    Int

  // Cost (in USD)
  cost            Decimal  @db.Decimal(8, 6)

  // Execution time
  durationMs      Int?

  // Additional context
  metadata        Json?    // Any extra context for debugging

  createdAt       DateTime @default(now())

  @@index([userId])
  @@index([dealId])
  @@index([analysisId])
  @@index([boardSessionId])
  @@index([model])
  @@index([agent])
  @@index([createdAt])
  @@index([userId, createdAt]) // For user cost queries
}

// COST ALERT - Persisted alerts for threshold violations
model CostAlert {
  id              String   @id @default(cuid())

  // Alert details
  type            CostAlertType
  severity        CostAlertSeverity

  message         String   @db.Text

  // Context
  userId          String?
  dealId          String?
  dealName        String?
  analysisId      String?

  // Values
  currentCost     Decimal  @db.Decimal(10, 4)
  threshold       Decimal  @db.Decimal(10, 4)

  // Status
  acknowledged    Boolean  @default(false)
  acknowledgedAt  DateTime?
  acknowledgedBy  String?  // Admin user ID

  // Notification tracking
  notificationSent Boolean @default(false)
  notificationSentAt DateTime?
  notificationChannel String? // "email", "in-app"

  createdAt       DateTime @default(now())

  @@index([userId])
  @@index([dealId])
  @@index([type])
  @@index([severity])
  @@index([acknowledged])
  @@index([createdAt])
}

enum CostAlertType {
  DEAL_THRESHOLD      // Deal total cost exceeded
  USER_DAILY          // User daily cost exceeded
  ANALYSIS_ANOMALY    // Single analysis cost anomaly
  BOARD_COST          // Board session cost exceeded
  MONTHLY_BUDGET      // Monthly budget threshold
}

enum CostAlertSeverity {
  INFO
  WARNING
  CRITICAL
}

// COST THRESHOLD CONFIG - Configurable thresholds per user/global
model CostThreshold {
  id              String   @id @default(cuid())

  // Scope: null = global, userId = user-specific
  userId          String?  @unique

  // Thresholds (in USD)
  dealWarning     Decimal  @db.Decimal(8, 2) @default(5.00)
  dealCritical    Decimal  @db.Decimal(8, 2) @default(15.00)
  userDailyWarning Decimal @db.Decimal(8, 2) @default(10.00)
  userDailyCritical Decimal @db.Decimal(8, 2) @default(25.00)
  analysisMax     Decimal  @db.Decimal(8, 2) @default(5.00)
  boardMax        Decimal  @db.Decimal(8, 2) @default(2.00)
  monthlyBudget   Decimal? @db.Decimal(10, 2) // Optional monthly cap

  // Notification preferences
  notifyOnWarning Boolean  @default(true)
  notifyOnCritical Boolean @default(true)
  notificationEmail String?

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([userId])
}

// ============================================================================
// DATABASE MAINTENANCE SYSTEM - Automated Data Quality Agents
// ============================================================================

// MAINTENANCE RUN - Individual execution of a maintenance agent
model MaintenanceRun {
  id              String            @id @default(cuid())

  agent           MaintenanceAgent
  status          MaintenanceStatus @default(PENDING)

  // Trigger info
  triggeredBy     TriggerSource     @default(CRON)
  parentRunId     String?           // If retry, link to original run
  retryAttempt    Int               @default(0)  // 0 = original, 1 = 1st retry, etc.

  // Execution timing
  scheduledAt     DateTime?         // When it was supposed to run
  startedAt       DateTime?
  completedAt     DateTime?
  durationMs      Int?

  // Stats
  itemsProcessed  Int               @default(0)
  itemsUpdated    Int               @default(0)
  itemsCreated    Int               @default(0)
  itemsFailed     Int               @default(0)
  itemsSkipped    Int               @default(0)

  // Details (agent-specific)
  details         Json?             // { duplicatesMerged, sourcesScraped, companiesEnriched, ... }
  errors          Json?             // Array of { message, stack, itemId? }

  // Cost tracking
  totalCost       Decimal?          @db.Decimal(8, 4)
  llmCalls        Int               @default(0)
  webSearches     Int               @default(0)

  // Supervisor tracking
  supervisorCheck SupervisorCheck?

  createdAt       DateTime          @default(now())

  @@index([agent])
  @@index([status])
  @@index([startedAt])
  @@index([triggeredBy])
  @@index([agent, startedAt])
}

// SUPERVISOR CHECK - Verification of a maintenance run
model SupervisorCheck {
  id              String            @id @default(cuid())

  // Link to the run being checked
  runId           String            @unique
  run             MaintenanceRun    @relation(fields: [runId], references: [id], onDelete: Cascade)

  // Check result
  checkStatus     CheckStatus
  checkDetails    Json?             // { expectedMinItems, actualItems, qualityBefore, qualityAfter, ... }

  // Action taken
  actionTaken     SupervisorAction  @default(NONE)
  retryRunId      String?           // ID of the retry run if triggered

  // Notifications sent
  telegramSent    Boolean           @default(false)
  telegramMsgId   String?           // Message ID for potential updates
  emailSent       Boolean           @default(false)

  // For retry verification
  isRetryCheck    Boolean           @default(false)
  retryCheckAt    DateTime?         // When to check the retry result

  checkedAt       DateTime          @default(now())

  @@index([checkStatus])
  @@index([checkedAt])
  @@index([actionTaken])
}

// WEEKLY REPORT - Generated summary of maintenance activity
model WeeklyReport {
  id              String            @id @default(cuid())

  // Period covered
  weekStart       DateTime
  weekEnd         DateTime

  // Overall health assessment
  overallStatus   HealthStatus

  // Agent summaries (JSON for flexibility)
  cleanerSummary  Json              // { runs, successful, failed, itemsProcessed, ... }
  sourcerSummary  Json
  completerSummary Json

  // Data quality metrics comparison
  dataQualityStart Json             // Snapshot at week start
  dataQualityEnd   Json             // Snapshot at week end
  qualityDelta     Json             // Computed changes

  // Issues & recovery stats
  issuesDetected  Int               @default(0)
  retriesTriggered Int              @default(0)
  retriesSuccessful Int             @default(0)
  retriesFailed    Int              @default(0)

  // Cost summary
  totalCost       Decimal           @db.Decimal(8, 4) @default(0)
  costByAgent     Json?             // { cleaner: 0, sourcer: 0.12, completer: 1.87 }

  // Delivery tracking
  emailSent       Boolean           @default(false)
  emailSentAt     DateTime?
  telegramSent    Boolean           @default(false)
  telegramSentAt  DateTime?

  // Raw report content (for re-sending)
  reportHtml      String?           @db.Text
  reportText      String?           @db.Text

  generatedAt     DateTime          @default(now())

  @@unique([weekStart])
  @@index([overallStatus])
  @@index([generatedAt])
}

// DATA QUALITY SNAPSHOT - Point-in-time DB health metrics
model DataQualitySnapshot {
  id              String            @id @default(cuid())

  // Counts
  totalCompanies  Int
  totalFundingRounds Int

  // Quality metrics
  avgDataQuality  Float             // 0-100 average
  companiesWithIndustry Int
  companiesWithDescription Int
  companiesWithFounders Int
  companiesWithWebsite Int
  companiesWithInvestors Int

  // Activity Status metrics
  companiesActive    Int            @default(0)
  companiesShutdown  Int            @default(0)
  companiesAcquired  Int            @default(0)
  companiesInactive  Int            @default(0)
  companiesStatusUnknown Int        @default(0)

  // Issues
  duplicateCompanies Int            @default(0)
  orphanedRounds     Int            @default(0)
  staleCompanies     Int            @default(0)  // Not enriched in 30+ days

  // Percentages (computed)
  withIndustryPct    Float
  withDescriptionPct Float
  withFoundersPct    Float
  withInvestorsPct   Float
  withStatusPct      Float          // Companies with known status
  stalePct           Float

  // Trigger (what caused this snapshot)
  trigger         String            @default("scheduled") // scheduled, before_agent, after_agent, manual
  relatedRunId    String?           // If triggered by agent run

  capturedAt      DateTime          @default(now())

  @@index([capturedAt])
  @@index([trigger])
}

// Enums for Maintenance System
enum MaintenanceAgent {
  DB_CLEANER
  DB_SOURCER
  DB_COMPLETER
}

enum MaintenanceStatus {
  PENDING      // Created, not yet started
  RUNNING      // Currently executing
  COMPLETED    // Finished successfully
  PARTIAL      // Finished but with some failures
  FAILED       // Total failure
  TIMEOUT      // Exceeded max duration (2h)
  CANCELLED    // Cancelled by supervisor or manual
}

enum TriggerSource {
  CRON         // Scheduled cron job
  SUPERVISOR   // Retry triggered by supervisor
  MANUAL       // Manual trigger via admin/telegram
  WEBHOOK      // External webhook
}

enum CheckStatus {
  PASSED       // All OK
  WARNING      // OK but degraded metrics
  FAILED       // The run failed
  MISSED       // The run didn't happen
  TIMEOUT      // The run timed out
  PENDING      // Check scheduled but not yet performed
}

enum SupervisorAction {
  NONE         // No action needed
  RETRY        // Triggered a retry
  ALERT_ONLY   // Alert sent (max retries reached)
  ESCALATE     // Critical escalation
}

enum HealthStatus {
  HEALTHY      // Everything OK
  DEGRADED     // Functional but minor issues
  CRITICAL     // Major problems
}

// COMPANY MERGE LOG - Audit trail for company deduplication
model CompanyMergeLog {
  id                  String   @id @default(cuid())

  // Companies involved
  mergedFromId        String   // Company that was deleted
  mergedIntoId        String   // Company that was kept
  mergedFromName      String
  mergedIntoName      String

  // Full state snapshots for audit/recovery
  beforeState         Json     // Complete state of both companies before merge
  afterState          Json     // State of kept company after merge

  // What was transferred
  fieldsTransferred   String[] // List of fields that were copied
  fundingRoundsTransferred Int @default(0)
  enrichmentsTransferred   Int @default(0)

  // Matching details
  similarityScore     Float    // Combined similarity score (0-1)
  similarityDetails   Json?    // { levenshtein, jaroWinkler, phonetic, normalized }
  matchReason         String?  // Why these were considered duplicates

  // Execution context
  mergedBy            String   @default("DB_CLEANER") // Agent or user who performed merge
  dryRun              Boolean  @default(false) // Was this a dry-run preview?
  maintenanceRunId    String?  // Link to the maintenance run if applicable

  createdAt           DateTime @default(now())

  @@index([mergedFromId])
  @@index([mergedIntoId])
  @@index([createdAt])
  @@index([maintenanceRunId])
}

// CACHE ENTRY - Persistent cache for expensive operations
model CacheEntry {
  id              String   @id @default(cuid())

  key             String   @unique
  value           Json

  expiresAt       DateTime

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([expiresAt])
}

// ============================================================================
// CONTEXT ENGINE & LLM PERSISTENCE
// ============================================================================

// CONTEXT ENGINE SNAPSHOT - Persisted enrichment data for a deal
// Saves Context Engine results to avoid re-fetching on reanalysis
model ContextEngineSnapshot {
  id              String   @id @default(cuid())
  dealId          String

  // Context Engine output (full JSON)
  dealIntelligence    Json?  // { similarDeals, fundingContext, competitors }
  marketData          Json?  // { marketSize, trends, news }
  competitiveLandscape Json? // { directCompetitors, indirectCompetitors }
  newsSentiment       Json?  // { articles, overallSentiment }
  peopleGraph         Json?  // { founders, connections }

  // Metadata
  completeness    Int      @default(0) // 0-100 how complete the data is
  connectorResults Json?   // { pappers: true, github: false, ... }

  // Source tracking (what was available when enriched)
  inputData       Json?    // { companyName, sector, stage, tagline, ... }

  // Validity
  expiresAt       DateTime // When to consider stale (default: 7 days)

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@unique([dealId]) // One snapshot per deal (overwritten on refresh)
  @@index([dealId])
  @@index([expiresAt])
}

// LLM CALL LOG - Raw prompts and responses for debugging/audit
model LLMCallLog {
  id              String   @id @default(cuid())

  // Linking
  analysisId      String?
  boardSessionId  String?
  agentName       String   // Which agent made the call

  // Model info
  model           String   // e.g., "claude-3-5-sonnet-20241022"
  provider        String   @default("openrouter") // openrouter, anthropic, openai

  // Request
  systemPrompt    String?  @db.Text
  userPrompt      String   @db.Text
  temperature     Float?
  maxTokens       Int?

  // Response
  response        String   @db.Text
  finishReason    String?  // stop, length, content_filter, etc.

  // Tokens & Cost
  inputTokens     Int
  outputTokens    Int
  totalTokens     Int
  cost            Decimal  @db.Decimal(10, 6)

  // Timing
  durationMs      Int
  firstTokenMs    Int?     // Time to first token (TTFT)

  // Error tracking (if failed)
  isError         Boolean  @default(false)
  errorMessage    String?  @db.Text
  errorType       String?  // rate_limit, timeout, content_filter, etc.

  // Metadata
  metadata        Json?    // Additional context (retry count, etc.)

  createdAt       DateTime @default(now())

  @@index([analysisId])
  @@index([boardSessionId])
  @@index([agentName])
  @@index([model])
  @@index([createdAt])
  @@index([isError])
}
